<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeStay - People</title>
    <link rel="stylesheet" href="./contacts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Only added missing modal styles that were referenced but not defined */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <!-- Header remains completely unchanged -->
    <header>
        <div class="logo"><img src="./public/logo-removebg-preview.png" alt="logo"></div>
        <nav>
            <a href="./index.html">Home</a>
            <a href="./contacts.html">Contacts</a>
            <a href="./message-templates.html">Messages</a>
            <a href="./campaigns.html">Campaigns</a>
        </nav>
        <button class="logout" onclick="logout()">Logout</button>
    </header>

    <!-- Main content structure unchanged -->
    <div class="main-content">
        <div class="header">
            <h1 class="page-title">People</h1>
            <button id="add-contact-btn" class="add-contact-btn">
                + Add contact
            </button>
        </div>

        <!-- Original Add Contact Modal (hidden by default) -->
        <div id="addContactModal" class="modal">
            <div class="modal-content">
                <h3>Add New Contact</h3>
                <form id="addContactForm">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>

                    <label for="tags">Tags:</label>
                    <input type="text" id="tags" name="tags" required>

                    <label for="phoneNumber">Phone:</label>
                    <input type="text" id="phoneNumber" name="phoneNumber" required>

                    <div class="button-group">
                        <button type="submit" class="save-btn">
                            <span id="saveBtnText">Save</span>
                            <span id="saveBtnSpinner" class="loading-spinner" style="display:none;"></span>
                        </button>
                        <button type="button" id="cancelBtn" class="cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabs unchanged -->
        <div class="tabs">
            <div class="tab active">Tenants</div>
            <div class="tab">Owners</div>
            <div class="tab">Service Pros</div>
        </div>

        <!-- Tenants header unchanged -->
        <div class="tenants-header">
            <h2 class="tenants-title">Tenants</h2>
            <div class="tenants-controls">
                <div class="tenants-search">
                    <input type="text" class="tenants-search-input" placeholder="Search tenants">
                    <div class="tenants-search-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                </div>
            </div>
        </div>

        <!-- Contacts container now has proper ID -->
        <div id="contact-list" class="tenants-grid">
            <div class="loading-state">
                <div class="loading-spinner large"></div>
                <p>Loading contacts...</p>
            </div>
        </div>

        <!-- Added popup container that was referenced in JS -->
        <div id="popup" class="modal">
            <div id="popup-content" class="modal-content"></div>
        </div>
    </div>

    <script>
// Original functionality preserved with only necessary fixes
const BASE_URL = "http://localhost:3000";

// Fixed element references (only changed selectors to match existing HTML)
const contactList = document.querySelector(".tenants-grid"); // Kept original class
const addContactBtn = document.querySelector(".add-contact-btn"); // Kept class selector
const popup = document.getElementById("popup");
const popupContent = document.getElementById("popup-content");

// Original fetchContacts function unchanged
async function fetchContacts() {
  try {
    const res = await fetch(`${BASE_URL}/contacts`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
      },
    });
    const data = await res.json();
    return Array.isArray(data) ? data : [data];
  } catch (error) {
    console.error("Error fetching contacts:", error);
    return [];
  }
}

// Original renderContacts with only null checks added
function renderContacts(contacts) {
  const container = document.querySelector(".tenants-grid");
  container.innerHTML = "";
  
  // Added check for empty state
  if (!contacts || contacts.length === 0) {
    container.innerHTML = '<div class="no-contacts">No contacts found</div>';
    return;
  }

  contacts.forEach((contact) => {
    const div = document.createElement("div");
    div.className = "tenant-card";
    div.innerHTML = `
      <div class="tenant-name">${contact.name || ''}</div>
      <div class="tenant-phone">${contact.phoneNumber || ''}</div>
      <div class="multi-manual">Tags: ${contact.tags ? contact.tags.join(", ") : ""}</div>
      <div class="tenant-actions">
        <button class="message-btn" onclick="openDetailsPopup(${contact.id})">More Details</button>
        <div class="tenant-action-seperation">
          <button class="view-profile-btn" onclick="openEditPopup(${contact.id})">Edit</button>
          <button class="view-profile-btn" onclick="showDeleteConfirmation(${contact.id})">Delete</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

// All original popup functions unchanged
function openAddPopup() {
  popupContent.innerHTML = `
    <h2>Add Contact</h2>
    <form onsubmit="submitAddForm(event)">
      <label>Name</label>
      <input type="text" id="name" required />
      <label>Phone Number</label>
      <input type="text" id="phone" required />
      <label>Tags (comma-separated)</label>
      <input type="text" id="tags" />
      <div class="button-group">
        <button type="submit" class="save-btn">Save</button>
        <button type="button" class="cancel-btn" onclick="closePopup()">Cancel</button>
      </div>
    </form>
  `;
  popup.style.display = "flex";
}

// Original submitAddForm unchanged
async function submitAddForm(event) {
  event.preventDefault();
  const name = document.getElementById("name").value;
  const phoneNumber = document.getElementById("phone").value;
  const tags = document.getElementById("tags").value.split(",").map(t => t.trim()).filter(Boolean);

  const contact = { name, phoneNumber, tags };

  try {
    await fetch(`${BASE_URL}/contacts`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
      },
      body: JSON.stringify(contact),
    });
    closePopup();
    loadContacts();
  } catch (error) {
    console.error("Error adding contact:", error);
  }
}

// Original openEditPopup unchanged
function openEditPopup(id) {
  fetch(`${BASE_URL}/contacts/${id}`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem("access_token")}`,
    },
  })
    .then((res) => res.json())
    .then((contact) => {
      popupContent.innerHTML = `
        <h2>Edit Contact</h2>
        <form onsubmit="submitEditForm(event, ${contact.id})">
          <label>Name</label>
          <input type="text" id="edit-name" value="${contact.name}" required />
          <label>Phone Number</label>
          <input type="text" id="edit-phone" value="${contact.phoneNumber}" required />
          <label>Tags (comma-separated)</label>
          <input type="text" id="edit-tags" value="${contact.tags ? contact.tags.join(", ") : ""}" />
          <div class="button-group">
            <button type="submit" class="save-btn">Update</button>
            <button type="button" class="cancel-btn" onclick="closePopup()">Cancel</button>
          </div>
        </form>
      `;
      popup.style.display = "flex";
    });
}

// Original submitEditForm unchanged
async function submitEditForm(event, id) {
  event.preventDefault();
  const name = document.getElementById("edit-name").value;
  const phoneNumber = document.getElementById("edit-phone").value;
  const tags = document.getElementById("edit-tags").value.split(",").map(t => t.trim()).filter(Boolean);

  const updatedContact = { name, phoneNumber, tags };

  try {
    await fetch(`${BASE_URL}/contacts/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
      },
      body: JSON.stringify(updatedContact),
    });
    closePopup();
    loadContacts();
  } catch (error) {
    console.error("Error updating contact:", error);
  }
}

// Original openDetailsPopup unchanged
function openDetailsPopup(id) {
  fetch(`${BASE_URL}/contacts/${id}`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem("access_token")}`,
    },
  })
    .then((res) => res.json())
    .then((contact) => {
      popupContent.innerHTML = `
        <h2>Contact Details</h2>
        <div class="contact-details">
          <div class="detail-row"><strong>Name:</strong> ${contact.name}</div>
          <div class="detail-row"><strong>Phone:</strong> ${contact.phoneNumber}</div>
          <div class="detail-row"><strong>Tags:</strong> ${contact.tags ? contact.tags.join(", ") : ""}</div>
        </div>
        <div class="button-group">
          <button class="cancel-btn" onclick="closePopup()">Close</button>
        </div>
      `;
      popup.style.display = "flex";
    });
}

// Original showDeleteConfirmation unchanged
function showDeleteConfirmation(id) {
  popupContent.innerHTML = `
    <div class="delete-modal">
      <h2>Confirm Delete</h2>
      <p>Are you sure you want to delete this contact?</p>
      <div class="button-group">
        <button class="delete-confirm-btn" onclick="deleteContact(${id})">Delete</button>
        <button class="cancel-btn" onclick="closePopup()">Cancel</button>
      </div>
    </div>
  `;
  popup.style.display = "flex";
}

// Original deleteContact unchanged
async function deleteContact(id) {
  try {
    await fetch(`${BASE_URL}/contacts/${id}`, {
      method: "DELETE",
      headers: {
        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
      },
    });
    closePopup();
    loadContacts();
  } catch (error) {
    console.error("Error deleting contact:", error);
  }
}

// Original closePopup unchanged
function closePopup() {
  popup.style.display = "none";
}

// Original loadContacts unchanged
function loadContacts() {
  fetchContacts().then(renderContacts);
}

// Original logout unchanged
function logout() {
  localStorage.removeItem("access_token");
  window.location.href = "login.html";
}

// Only changed initialization to ensure elements exist
document.addEventListener("DOMContentLoaded", () => {
  // Check if user is authenticated
  if (!localStorage.getItem("access_token")) {
    window.location.href = "login.html";
    return;
  }

  // Initialize only if elements exist
  if (addContactBtn) {
    addContactBtn.addEventListener("click", openAddPopup);
  }
  
  loadContacts();
});
</script>
</body>
</html>