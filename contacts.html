<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeStay - People</title>
    <link rel="stylesheet" href="./contacts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Only added missing modal styles that were referenced but not defined */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <!-- Header remains completely unchanged -->
    <header>
        <div class="logo"><img src="./public/logo-removebg-preview.png" alt="logo"></div>
        <nav>
            <a href="./index.html">Home</a>
            <a href="./contacts.html">Contacts</a>
            <a href="./message-templates.html">Messages</a>
            <a href="./campaigns.html">Campaigns</a>
        </nav>
        <button class="logout" onclick="logout()">Logout</button>
    </header>

    <!-- Main content structure unchanged -->
    <div class="main-content">
        <div class="header">
            <h1 class="page-title">People</h1>
            <button id="add-contact-btn" class="add-contact-btn">
                + Add contact
            </button>
        </div>

        <!-- Original Add Contact Modal (hidden by default) -->
        <div id="addContactModal" class="modal">
            <div class="modal-content">
                <h3>Add New Contact</h3>
                <form id="addForm">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>

                    <label for="tags">Tags:</label>
                    <input type="text" id="tags" name="tags" required>

                    <label for="phoneNumber">Phone:</label>
                    <input type="text" id="phoneNumber" name="phoneNumber" required>

                    <div class="button-group">
                        <button type="submit" class="save-btn">
                            <span id="saveBtnText">Save</span>
                            <span id="saveBtnSpinner" class="loading-spinner" style="display:none;"></span>
                        </button>
                        <button type="button" id="cancelBtn" class="cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabs unchanged -->
        <div class="tabs">
            <div class="tab active">Tenants</div>
            <div class="tab">Owners</div>
            <div class="tab">Service Pros</div>
        </div>

        <!-- Tenants header unchanged -->
        <div class="tenants-header">
            <h2 class="tenants-title">Tenants</h2>
            <div class="tenants-controls">
                <div class="tenants-search">
                    <input type="text" class="tenants-search-input" placeholder="Search tenants">
                    <div class="tenants-search-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                </div>
            </div>
        </div>

        <!-- Contacts container now has proper ID -->
        <div id="contact-list" class="tenants-grid">
            <div class="loading-state">
                <div class="loading-spinner large"></div>
                <p>Loading contacts...</p>
            </div>
        </div>

        <!-- Added popup container that was referenced in JS -->
        <div id="popup" class="modal">
            <div id="popup-content" class="modal-content"></div>
        </div>
    </div>

    <script>
     document.addEventListener('DOMContentLoaded', function() {
    const BASE_URL = "http://localhost:3000"; // Update with your actual backend URL
    
    // Elements
    const addContactBtn = document.getElementById("add-contact-btn");
    const addContactModal = document.getElementById("addContactModal");
    const addForm = document.getElementById("addForm");
    const cancelBtn = document.getElementById("cancelBtn");
    const contactList = document.getElementById("contact-list");
    const popup = document.getElementById("popup");
    const popupContent = document.getElementById("popup-content");

    // Event Listeners
    addContactBtn?.addEventListener("click", () => addContactModal.style.display = "block");
    cancelBtn?.addEventListener("click", () => addContactModal.style.display = "none");
    
    // Close modal when clicking outside
    window.addEventListener("click", (e) => {
        if (e.target === addContactModal) {
            addContactModal.style.display = "none";
        }
        if (e.target === popup) {
            popup.style.display = "none";
        }
    });

    // ---------------- Fetch Contacts ----------------
    async function fetchContacts() {
        try {
            const res = await fetch(`${BASE_URL}/contacts`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                },
            });
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const data = await res.json();
            return Array.isArray(data?.data) ? data.data : [];
        } catch (err) {
            console.error("Error fetching contacts:", err);
            throw err;
        }
    }

    // ---------------- Render Contacts ----------------
    async function renderContacts() {
        contactList.innerHTML = '<div class="loading-state"><div class="loading-spinner large"></div><p>Loading contacts...</p></div>';
        
        try {
            const contacts = await fetchContacts();
            
            if (contacts.length === 0) {
                contactList.innerHTML = '<div class="no-contacts">No contacts found</div>';
                return;
            }

            contactList.innerHTML = '';
            
            contacts.forEach((contact) => {
                if (!contact.id) return;

                // Safely handle tags - ensure it's always an array
                const tags = Array.isArray(contact.tags) ? contact.tags : 
                            (typeof contact.tags === 'string' ? contact.tags.split(',') : 
                            (contact.tags ? [contact.tags] : []));

                const div = document.createElement("div");
                div.className = "tenant-card";
                div.innerHTML = `
                    <div class="tenant-name">${contact.name || ''}</div>
                    <div class="tenant-phone">${contact.phoneNumber || ''}</div>
                    <div class="multi-manual">Tags: ${tags.join(", ")}</div>
                    <div class="tenant-actions">
                        <button class="message-btn" data-id="${contact.id}">More Details</button>
                        <div class="tenant-action-seperation">
                            <button class="view-profile-btn" data-id="${contact.id}">Edit</button>
                            <button class="view-profile-btn" data-id="${contact.id}">Delete</button>
                        </div>
                    </div>
                `;
                contactList.appendChild(div);
            });

            // Add event listeners after rendering
            document.querySelectorAll('.message-btn').forEach(btn => {
                btn.addEventListener('click', () => openDetailsPopup(btn.dataset.id));
            });
            
            document.querySelectorAll('.tenant-action-seperation .view-profile-btn:nth-child(1)').forEach(btn => {
                btn.addEventListener('click', () => openEditPopup(btn.dataset.id));
            });
            
            document.querySelectorAll('.tenant-action-seperation .view-profile-btn:nth-child(2)').forEach(btn => {
                btn.addEventListener('click', () => showDeleteConfirmation(btn.dataset.id));
            });

        } catch (err) {
            console.error("Error rendering contacts:", err);
            contactList.innerHTML = `<div class="error-state">Error loading contacts: ${err.message}</div>`;
        }
    }

    // ---------------- Add Contact ----------------
    addForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = addForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
        submitBtn.disabled = true;

        try {
            const name = document.getElementById("name").value;
            const phoneNumber = document.getElementById("phoneNumber").value;
            const tags = document.getElementById("tags").value 
                ? document.getElementById("tags").value.split(',').map(tag => tag.trim()) 
                : [];

            const res = await fetch(`${BASE_URL}/contacts`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                },
                body: JSON.stringify({ name, phoneNumber, tags }),
            });
            
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({}));
                throw new Error(errorData.message || 'Failed to add contact');
            }
            
            addContactModal.style.display = "none";
            addForm.reset();
            await renderContacts();
        } catch (err) {
            console.error("Error adding contact:", err);
            alert(`Failed to add contact: ${err.message}`);
        } finally {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
        }
    });

    // ---------------- Edit Contact ----------------
    async function openEditPopup(id) {
        if (!id) return;
        
        try {
            // Show loading state in popup
            popupContent.innerHTML = '<div class="loading-state"><div class="loading-spinner large"></div><p>Loading contact...</p></div>';
            popup.style.display = "block";

            const res = await fetch(`${BASE_URL}/contacts/${id}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                },
            });
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const contact = await res.json();
            
            // Safely handle tags
            const tagsValue = Array.isArray(contact.tags) ? contact.tags.join(', ') : 
                            (typeof contact.tags === 'string' ? contact.tags : 
                            (contact.tags ? contact.tags : ''));
            
            popupContent.innerHTML = `
                <h3>Edit Contact</h3>
                <form id="editForm">
                    <input type="hidden" id="editId" value="${contact.id}">
                    <label for="editName">Name:</label>
                    <input type="text" id="editName" value="${contact.name || ''}" required>
                    
                    <label for="editPhone">Phone:</label>
                    <input type="text" id="editPhone" value="${contact.phoneNumber || ''}" required>
                    
                    <label for="editTags">Tags (comma separated):</label>
                    <input type="text" id="editTags" value="${tagsValue}">
                    
                    <div class="button-group">
                        <button type="submit" class="save-btn">Save</button>
                        <button type="button" class="cancel-btn" onclick="document.getElementById('popup').style.display='none'">Cancel</button>
                    </div>
                </form>
            `;
            
            document.getElementById("editForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
                submitBtn.disabled = true;

                try {
                    const name = document.getElementById("editName").value;
                    const phoneNumber = document.getElementById("editPhone").value;
                    const tags = document.getElementById("editTags").value 
                        ? document.getElementById("editTags").value.split(',').map(tag => tag.trim()) 
                        : [];
                    
                    const res = await fetch(`${BASE_URL}/contacts/${id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                        },
                        body: JSON.stringify({ name, phoneNumber, tags }),
                    });
                    
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Failed to update contact');
                    }
                    
                    popup.style.display = "none";
                    await renderContacts();
                } catch (err) {
                    console.error("Error updating contact:", err);
                    alert(`Failed to update contact: ${err.message}`);
                } finally {
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                }
            });
        } catch (err) {
            console.error("Error opening edit popup:", err);
            popupContent.innerHTML = `
                <div class="error-state">
                    <p>Error loading contact: ${err.message}</p>
                    <button class="cancel-btn" onclick="document.getElementById('popup').style.display='none'">Close</button>
                </div>
            `;
        }
    }

    // ---------------- Delete Contact ----------------
    function showDeleteConfirmation(id) {
        popupContent.innerHTML = `
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this contact?</p>
            <div class="button-group">
                <button id="confirmDeleteBtn" class="delete-btn">Delete</button>
                <button class="cancel-btn" onclick="document.getElementById('popup').style.display='none'">Cancel</button>
            </div>
        `;
        
        popup.style.display = "block";
        
        document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
            try {
                const btn = document.getElementById("confirmDeleteBtn");
                const originalBtnText = btn.innerHTML;
                btn.innerHTML = '<span class="loading-spinner"></span> Deleting...';
                btn.disabled = true;

                const res = await fetch(`${BASE_URL}/contacts/${id}`, {
                    method: "DELETE",
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                    },
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to delete contact');
                }
                
                popup.style.display = "none";
                await renderContacts();
            } catch (err) {
                console.error("Error deleting contact:", err);
                alert(`Failed to delete contact: ${err.message}`);
            }
        });
    }

    // ---------------- View Contact Details ----------------
    async function openDetailsPopup(id) {
        if (!id) return;
        
        try {
            // Show loading state in popup
            popupContent.innerHTML = '<div class="loading-state"><div class="loading-spinner large"></div><p>Loading contact details...</p></div>';
            popup.style.display = "block";

            const res = await fetch(`${BASE_URL}/contacts/${id}`, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem("access_token")}`,
                },
            });
            
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const contact = await res.json();
            
            // Safely handle tags
            const tagsDisplay = Array.isArray(contact.tags) ? contact.tags.join(', ') : 
                              (typeof contact.tags === 'string' ? contact.tags : 
                              (contact.tags ? contact.tags : 'None'));
            
            popupContent.innerHTML = `
                <h3>Contact Details</h3>
                <div class="contact-details">
                    <p><strong>Name:</strong> ${contact.name || 'Not specified'}</p>
                    <p><strong>Phone:</strong> ${contact.phoneNumber || 'Not specified'}</p>
                    <p><strong>Tags:</strong> ${tagsDisplay}</p>
                    <p><strong>Created:</strong> ${new Date(contact.createdAt).toLocaleString()}</p>
                </div>
                <button class="cancel-btn" onclick="document.getElementById('popup').style.display='none'" style="margin-top: 20px;">Close</button>
            `;
        } catch (err) {
            console.error("Error fetching contact details:", err);
            popupContent.innerHTML = `
                <div class="error-state">
                    <p>Error loading contact details: ${err.message}</p>
                    <button class="cancel-btn" onclick="document.getElementById('popup').style.display='none'">Close</button>
                </div>
            `;
        }
    }

    // ---------------- Initial Render ----------------
    renderContacts();

    // Make functions available globally for HTML onclick handlers
    window.openDetailsPopup = openDetailsPopup;
    window.openEditPopup = openEditPopup;
    window.showDeleteConfirmation = showDeleteConfirmation;
});
</script>
</body>
</html>